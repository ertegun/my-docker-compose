version: "3.9"
name: media-stack
services:
  qbittorrent:
    container_name: qbittorrent
    image: lscr.io/linuxserver/qbittorrent:latest
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
      - WEBUI_PORT=5080
    volumes:
      - /mnt/depo/qbittorrent:/config
      - /mnt/arsiv:/downloads
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5080"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 256M
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.media-stack.service=qbittorrent"
      - "com.media-stack.description=Torrent Client"

    ## Comment/Disable below ports if VPN is enabled
    ports:
      - 5080:5080
      - 6881:6881
      - 6881:6881/udp
    restart: "unless-stopped"

  radarr:
    container_name: radarr
    image: lscr.io/linuxserver/radarr:latest
    # Uses default network
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
    ports:
      - 7878:7878
    volumes:
      - /mnt/depo/radarr:/config
      - /mnt/arsiv:/downloads
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7878/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.media-stack.service=radarr"
      - "com.media-stack.description=Movie Management"
    restart: "unless-stopped"

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    # Uses default network
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
    volumes:
      - /mnt/depo/sonarr:/config
      - /mnt/arsiv:/downloads
    ports:
      - 8989:8989
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8989/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.media-stack.service=sonarr"
      - "com.media-stack.description=TV Series Management"
    restart: unless-stopped

  prowlarr:
    container_name: prowlarr
    image: lscr.io/linuxserver/prowlarr:latest

    # Uncomment below if vpn is enabled
    # depends_on:               # Uncomment this line if vpn is enabled
    #   - vpn                   # Uncomment this line if vpn is enabled
    # network_mode: service:vpn # Uncomment this line if vpn is enabled

    # Uses default network

    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
    volumes:
      - /mnt/depo/prowlarr:/config
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9696/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.media-stack.service=prowlarr"
      - "com.media-stack.description=Indexer Manager"

    # Comment below ports if VPN is enabled.
    ports:
      - 9696:9696
    restart: unless-stopped

  jellyfin:
    image: lscr.io/linuxserver/jellyfin:latest
    container_name: jellyfin
    # Uses default network
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
      - JELLYFIN_PublishedServerUrl=http://localhost:8096
    volumes:
      - /mnt/depo/jellyfin:/config
      - /mnt/arsiv:/data
      - /mnt/depo/jellyfin-cache:/cache
    devices:
      - /dev/dri:/dev/dri # Intel Quick Sync Video (9th Gen i7)
    group_add:
      - "109" # render group (check with: getent group render)
      - "44" # video group (check with: getent group video)
    ports:
      - 8096:8096
      - 7359:7359/udp
      - 8920:8920
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8096/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    deploy:
      resources:
        limits:
          cpus: "4"
          memory: 2G
        reservations:
          cpus: "1"
          memory: 512M
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.media-stack.service=jellyfin"
      - "com.media-stack.description=Media Server"
    restart: unless-stopped

  # Subtitle management
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    # Uses default network
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
    volumes:
      - /mnt/depo/bazarr:/config
      - /mnt/arsiv:/downloads
    ports:
      - 6767:6767
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6767/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.media-stack.service=bazarr"
      - "com.media-stack.description=Subtitle Management"
    restart: unless-stopped

  # Request management UI
  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    # Uses default network
    environment:
      - LOG_LEVEL=info
      - TZ=UTC
    volumes:
      - /mnt/depo/jellyseerr:/app/config
    ports:
      - 5055:5055
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5055/api/v1/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.media-stack.service=jellyseerr"
      - "com.media-stack.description=Media Request Management"
    restart: unless-stopped

  # Cloudflare bypass for Prowlarr
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    # Uses default network
    environment:
      - LOG_LEVEL=info
      - LOG_HTML=false
      - CAPTCHA_SOLVER=none
      - TZ=UTC
    ports:
      - 8191:8191
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8191/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 256M
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "com.media-stack.service=flaresolverr"
      - "com.media-stack.description=Cloudflare Bypass"
    restart: unless-stopped
