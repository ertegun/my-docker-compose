services:
  adguardhome:
    image: adguard/adguardhome:latest
    container_name: adguardhome
    restart: unless-stopped
    stop_grace_period: 30s
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.5"
          memory: 256M
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=adguardhome"
    labels:
      - "com.example.description=AdGuard Home DNS/DHCP Server"
      - "com.example.version=production"
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      # Expose port 67 on UDP for DHCP server
      - "67:67/udp"
      # Expose port 68 on UDP for DHCP client
      # - "68:68/udp"
      # Expose port 80 on TCP for HTTP web interface
      - "80:80/tcp"
      # Expose port 443 on TCP and UDP for HTTPS web interface
      - "443:443/tcp"
      - "443:443/udp"
      # Expose port 3000 on TCP for AdGuard Home's API
      - "3000:3000/tcp"
      # Expose port 853 on TCP for DNS-over-TLS (DoT)
      - "853:853/tcp"
      # Expose port 784 on UDP for DNS-over-QUIC (DoQ)
      - "784:784/udp"
      # Expose port 853 on UDP for DNS-over-DTLS (DoT)
      - "853:853/udp"
      # Expose port 8853 on UDP for DNS-over-TLS (DoT)
      - "8853:8853/udp"
      # Expose port 5443 on TCP and UDP for DNSCrypt
      - "5443:5443/tcp"
      - "5443:5443/udp"
    volumes: # Mount named volumes inside the container
      - adguard-work:/opt/adguardhome/work:rw
      - adguard-conf:/opt/adguardhome/conf:rw
    networks:
      - adguard-network

networks:
  adguard-network:
    driver: bridge

volumes:
  adguard-work:
    driver: local
  adguard-conf:
    driver: local
